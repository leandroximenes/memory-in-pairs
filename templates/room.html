{% extends "layout.html" %}

{% block title %}
Room teste
{% endblock %}

{% block main %}
<div>
    <h1 class="text-lg font-bold mb-2" id="roomName">Room: {{ title }}</h1>
    <a href="/" class="small-btn mr-6 py-2">Leave room</a>
    <div class="grid grid-cols-11 gap-2 px-2 py-5">
        <div class="col-span-5 shadow-md bg-white py-2">
            <div class="text-lg font-bold pr-2 flex justify-end" id="player0">

            </div>
        </div>
        <div class="py-2">
            <h1 class="text-lg font-bold">Vs</h1>
        </div>
        <div class="col-span-5 shadow-md bg-white py-2">
            <div class="text-lg font-bold pr-2 flex justify-start" id="player1">
            </div>
        </div>
    </div>
    <div class="grid gap-2 grid-cols-4 lg:grid-cols-7 shadow-md bg-white w-auto p-2" style="display: none;"
        id="playerSpace">
        {%for item in imageList%}
        <img class="card" data-card="{{ item.file }}" data-hash="{{ item.hash }}" src="/static/img/{{ item.file }}">
        {%endfor%}
        <img class="p-2 rounded-lg shadow-lg bg-gray-300 invisible lg:visible" src="/static/img/CS50.png">
    </div>
</div>

<script>
    document.onreadystatechange = () => {
        if (document.readyState === "complete") {
            document.querySelector('#playerSpace').style.display = "grid";
        }
    };

    // socket connection recived from webpack configurated and runing.
    // first default message is: "conected"
    // publicInfo => default broadcast message
    let roomName = document.querySelector("#roomName").innerHTML.replace('Room: ', '')
    socket.onmessage = ({ data }) => {
        const event = JSON.parse(data);
        switch (event.type) {
            case "conected":
                socket.send(JSON.stringify({ action: "enterRoom", roomName: roomName }));
                document.querySelectorAll('.card').forEach(card => {
                    card.addEventListener("click",
                        function (el) {
                            el.src = el.src.indexOf('card.png') != -1 ? '/static/img/' + el.dataset.card : '/static/img/card.png';
                           console.log('here')
                        });
                });
                break
            case "publicInfo":
                let players = []
                if (players.length < 2) {
                    players = event.users.filter(user => user.room == roomName)
                }
                for (let i = 0; i < players.length; i++) {
                    setPlayer(players[i], i)
                }
                break
            default:
                console.error("unsupported event", event.type)
        }
    }

    function setPlayer(player, order) {
        let spanName = document.createElement("span")
        spanName.classList.add('mx-2');
        spanName.innerHTML = player.name;

        let spanScore = document.createElement("span")
        spanScore.classList.add('bg-gray-300', 'rounded-full', 'px-2')
        spanScore.innerHTML = player.score;

        let div = document.querySelector("#player" + order)
        div.innerHTML = ""
        if (order == 0) {
            div.append(spanName)
            div.append(spanScore)
        } else {
            div.append(spanScore)
            div.append(spanName)
        }
    }

    function chngimg(el) {
        
    }
</script>
{% endblock %}